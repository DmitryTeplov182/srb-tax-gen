<!DOCTYPE html>
<!--
/*
 * ------------------------------------------------------------
 * "THE BEERWARE LICENSE" (Revision 42):
 * <author> wrote this code. As long as you retain this 
 * notice, you can do whatever you want with this stuff. If we
 * meet someday, and you think this stuff is worth it, you can
 * buy me a beer in return.
 * ------------------------------------------------------------
 */
-->
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–ª–æ–≥ –∑–∞ —É–ø–ª–∞—Ç—É - NBS IPS QR –∫–æ–¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Times New Roman', serif;
            background: #f5f5f5;
            padding: 20px;
            min-height: 100vh;
        }

        .payment-form {
            background: white;
            border: 2px solid #000;
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-header {
            text-align: right;
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #000;
        }

        .form-content {
            display: grid;
            grid-template-columns: 1fr 1px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .left-section {
            padding-right: 20px;
        }

        .divider {
            background: #000;
            width: 1px;
        }

        .right-section {
            padding-left: 20px;
            display: flex;
            flex-direction: column;
        }

        .field-group {
            margin-bottom: 25px;
        }

        .field-label {
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: normal;
        }

        .field-input {
            width: 100%;
            border: 1px solid #000;
            border-radius: 0;
            padding: 8px;
            font-size: 14px;
            font-family: inherit;
            background: white;
        }

        .field-input:focus {
            outline: none;
            border: 2px solid #000;
        }

        textarea.field-input {
            resize: vertical;
            min-height: 60px;
        }

        .right-top-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1.5fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .right-top-row .field-group {
            margin-bottom: 0;
        }

        .right-top-row .field-input {
            text-align: center;
        }

        .currency-field {
            background: #f0f0f0;
            cursor: not-allowed;
        }

        .account-row {
            margin-bottom: 20px;
        }

        .model-reference-row {
            display: grid;
            grid-template-columns: 0.5fr 1.5fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .model-reference-row .field-group {
            margin-bottom: 0;
        }

        .qr-section {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            margin-top: auto;
            padding-top: 0;
        }

        .qr-container {
            text-align: center;
            min-width: 200px;
        }

        #qrcode {
            border: 1px solid #000;
            padding: 10px;
            background: white;
            display: inline-block;
            min-width: 200px;
            min-height: 200px;
            position: relative;
        }

        #qrcode img {
            display: block;
            max-width: 200px;
            height: auto;
        }

        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: #fff;
            border: 1px solid #ddd;
            display: block;
        }

        .error {
            color: #d32f2f;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .char-counter {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }

        .char-counter.warning {
            color: #f57c00;
        }

        .char-counter.error {
            color: #d32f2f;
        }

        .action-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        button {
            padding: 12px 24px;
            border: 2px solid #000;
            background: white;
            color: #000;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
        }

        button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .debug-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px dashed #999;
            background: #f9f9f9;
            font-size: 12px;
            display: none;
            max-width: 100%;
            overflow-x: auto;
            box-sizing: border-box;
        }

        .debug-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: #333;
        }

        .debug-json {
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
            overflow-x: auto;
            max-width: 100%;
            box-sizing: border-box;
        }

        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffc107;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
            box-sizing: border-box;
        }

        .debug-info pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-all;
            max-width: 100%;
            overflow-x: auto;
            margin: 5px 0;
            padding: 5px;
            background: #fff;
            border: 1px solid #ddd;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.4;
        }

        .debug-error {
            background: #f8d7da;
            border: 1px solid #dc3545;
            color: #721c24;
        }

        .debug-success {
            background: #d4edda;
            border: 1px solid #28a745;
            color: #155724;
        }

        .description-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            line-height: 1.6;
            color: #666;
        }

        .description-section h4 {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .description-section p {
            margin-bottom: 8px;
        }

        .description-section a {
            color: #0066cc;
            text-decoration: none;
        }

        .description-section a:hover {
            text-decoration: underline;
        }

        .description-section ul {
            margin-left: 20px;
            margin-top: 8px;
            margin-bottom: 8px;
            padding-left: 20px;
        }

        .description-section li {
            margin-bottom: 5px;
        }

        .disclaimer {
            margin-top: 15px;
            padding: 10px;
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            font-size: 11px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .payment-form {
                padding: 15px;
                max-width: 100%;
            }

            .form-header {
                font-size: 14px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .form-header > div {
                width: 100%;
            }

            .form-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .divider {
                display: none;
            }

            .left-section {
                padding-right: 0;
            }

            .right-section {
                padding-left: 0;
            }

            .right-top-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .model-reference-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .qr-section {
                justify-content: center;
                margin-top: 20px;
            }

            .qr-container {
                width: 100%;
                max-width: 200px;
            }

            #qrcode {
                width: 100%;
                min-width: auto;
            }

            .qr-placeholder {
                width: 100%;
                max-width: 200px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }

            button {
                width: 100%;
                padding: 14px;
            }

            .field-group {
                margin-bottom: 20px;
            }

            .field-input {
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
            }

            .description-section {
                font-size: 11px;
            }

            .description-section h4 {
                font-size: 13px;
            }

            .debug-section {
                padding: 15px;
                font-size: 11px;
            }

            .debug-section h3 {
                font-size: 14px;
            }

            .debug-info {
                padding: 8px;
                font-size: 11px;
            }

            .debug-info pre {
                font-size: 10px;
                padding: 8px;
            }

            .debug-json {
                font-size: 10px;
                padding: 8px;
            }
        }

        /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .payment-form {
                padding: 10px;
            }

            .form-header {
                font-size: 12px;
            }

            .field-label {
                font-size: 11px;
            }

            .field-input {
                padding: 10px;
                font-size: 16px;
            }

            button {
                padding: 12px;
                font-size: 13px;
            }

            .debug-section {
                padding: 10px;
                font-size: 10px;
            }

            .debug-section h3 {
                font-size: 13px;
            }

            .debug-info {
                padding: 6px;
                font-size: 10px;
            }

            .debug-info pre {
                font-size: 9px;
                padding: 6px;
            }

            .debug-json {
                font-size: 9px;
                padding: 6px;
            }
        }

        @media print {
            .action-buttons,
            .debug-section,
            .description-section {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="payment-form">
        <div class="form-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <label for="paymentType" style="font-size: 14px; font-weight: normal; margin-right: 10px;">–¢–∏–ø –ø–ª–∞—Ç–µ–∂–∫–µ:</label>
                <select id="paymentType" style="padding: 5px 10px; border: 1px solid #000; font-size: 14px; font-family: inherit;">
                    <option value="pio">–î–æ–ø—Ä–∏–Ω–æ—Å –∑–∞ –ü–ò–û</option>
                    <option value="zdro">–î–æ–ø—Ä–∏–Ω–æ—Å –∑–∞ –ó–î–†–û</option>
                    <option value="nez">–î–æ–ø—Ä–∏–Ω–æ—Å –∑–∞ –ù–ï–ó</option>
                    <option value="paus">–ü–æ—Ä–µ–∑ –Ω–∞ –ø–∞—É—à–∞–ª–Ω–∏ –ø—Ä–∏—Ö–æ–¥</option>
                </select>
            </div>
            <div>–ù–ê–õ–û–ì –ó–ê –£–ü–õ–ê–¢–£</div>
        </div>

        <div class="form-content">
            <div class="left-section">
                <div class="field-group">
                    <div class="field-label">—É–ø–ª–∞—Ç–∏–ª–∞—Ü</div>
                    <textarea id="fieldP" class="field-input" placeholder="–ò–º–µ –∏ –∞–¥—Ä–µ—Å–∞ —É–ø–ª–∞—Ç–∏–æ—Ü–∞"></textarea>
                </div>

                <div class="field-group">
                    <div class="field-label">—Å–≤—Ä—Ö–∞ —É–ø–ª–∞—Ç–µ</div>
                    <textarea id="fieldS" class="field-input" maxlength="35" placeholder="–ù–∞–∑–Ω–∞—á–µ—ö–µ —É–ø–ª–∞—Ç–µ" required></textarea>
                    <div class="char-counter" id="fieldSCounter">35</div>
                </div>

                <div class="field-group">
                    <div class="field-label">–ø—Ä–∏–º–∞–ª–∞—Ü</div>
                    <textarea id="fieldN" class="field-input" placeholder="–ù–∞–∑–∏–≤ –ø—Ä–∏–º–∞–æ—Ü–∞" required></textarea>
                </div>
            </div>

            <div class="divider"></div>

            <div class="right-section">
                <div class="right-top-row">
                    <div class="field-group">
                        <div class="field-label">—à–∏—Ñ—Ä–∞ –ø–ª–∞—õ–∞—ö–∞</div>
                        <input type="text" id="fieldSF" class="field-input" value="253" required>
                    </div>
                    <div class="field-group">
                        <div class="field-label">–≤–∞–ª—É—Ç–∞</div>
                        <input type="text" class="field-input currency-field" value="–¥–∏–Ω." readonly>
                    </div>
                    <div class="field-group">
                        <div class="field-label">–∏–∑–Ω–æ—Å</div>
                        <input type="text" id="fieldI" class="field-input" placeholder="0,00" required>
                    </div>
                </div>

                <div class="account-row">
                    <div class="field-group">
                        <div class="field-label">—Ä–∞—á—É–Ω –ø—Ä–∏–º–∞–æ—Ü–∞</div>
                        <input type="text" id="fieldR" class="field-input" placeholder="840-000000000000000-00" required>
                    </div>
                </div>

                <div class="model-reference-row">
                    <div class="field-group">
                        <div class="field-label">–º–æ–¥–µ–ª</div>
                        <input type="text" id="fieldModel" class="field-input" value="97" required>
                    </div>
                    <div class="field-group">
                        <div class="field-label">–ø–æ–∑–∏–≤ –Ω–∞ –±—Ä–æ—ò (–æ–¥–æ–±—Ä–µ—ö–µ)</div>
                        <input type="text" id="fieldRO" class="field-input" placeholder="6222390000007106209" required>
                    </div>
                </div>

                <div class="qr-section">
                    <div class="qr-container">
                        <div id="qrcode">
                            <div class="qr-placeholder"></div>
                        </div>
                        <div id="error" class="error"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button id="generateBtn" onclick="generateQR()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥</button>
            <button id="nextBtn" onclick="nextPayment()">–°–ª–µ–¥—É—é—â–∞—è –ø–ª–∞—Ç–µ–∂–∫–∞</button>
            <button id="debugToggleBtn" onclick="toggleDebug()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É</button>
        </div>

        <div class="action-buttons" style="margin-top: 10px;">
            <button onclick="saveToFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª</button>
            <button onclick="document.getElementById('fileInput').click()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
            <input type="file" id="fileInput" accept=".txt" style="display: none;" onchange="loadFromFile(event)">
        </div>

        <div class="debug-section">
            <h3>üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div id="debugInfo" class="debug-info">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥"</div>
            <div id="debugJson" class="debug-json" style="display: none;"></div>
        </div>

        <div class="description-section">
            <h4>–û —Å–µ—Ä–≤–∏—Å–µ</h4>
            <p>–ù–∞–ø–∏—Å–∞–Ω–Ω—ã–π –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–¥–æ–±–Ω–æ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É. –í –æ–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü.</p>
            <p>–°–µ—Ä–≤–∏—Å –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –≤—Å–µ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è —É –≤–∞—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è API –ù–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –±–∞–Ω–∫–∞ –°–µ—Ä–±–∏–∏.</p>
            
            <h4 style="margin-top: 20px; margin-bottom: 10px;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</h4>
            <p>–í—Å–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±—Ä–∞—É–∑–µ—Ä–∞ (localStorage). –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ:</p>
            <ul>
                <li>–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä</li>
                <li>–ü—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ç–∏–ø–∞–º–∏ –ø–ª–∞—Ç–µ–∂–µ–∫ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                <li>–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</li>
                <li>–í—ã –º–æ–∂–µ—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</li>
                <li>–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞</li>
            </ul>
            <p><strong>–í–∞–∂–Ω–æ:</strong> –ü—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.</p>
            
            <div class="disclaimer">
                <strong>–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:</strong> –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è "–∫–∞–∫ –µ—Å—Ç—å" –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –≥–∞—Ä–∞–Ω—Ç–∏–π. –ê–≤—Ç–æ—Ä—ã –Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –ª—é–±—ã–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏ –≤ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –ø–ª–∞—Ç–µ–∂–∫–∞—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º.
            </div>
            
            <p style="margin-top: 15px;">
                –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ <a href="https://github.com/DmitryTeplov182/srb-tax-gen" target="_blank">GitHub</a>.
            </p>
        </div>
    </div>

    <script>
        // –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è API
        const hiddenFields = {
            K: "PR",
            V: "01",
            C: "1"
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
        function processTextField(value) {
            if (!value) return '';
            return value.trim();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ MM.YY
        function getPreviousMonthYear() {
            const now = new Date();
            const previousMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const month = String(previousMonth.getMonth() + 1).padStart(2, '0');
            const year = String(previousMonth.getFullYear()).slice(-2);
            return `${month}.${year}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è JSON –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è API generate
        function jsonToTextFormat(jsonData) {
            const parts = [];
            
            // –ü–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            const fieldOrder = ['K', 'V', 'C', 'R', 'N', 'I', 'P', 'SF', 'S', 'RO'];
            
            for (const field of fieldOrder) {
                if (jsonData[field] !== undefined && jsonData[field] !== null && jsonData[field] !== '') {
                    parts.push(`${field}:${jsonData[field]}`);
                }
            }
            
            return parts.join('|');
        }

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–∫
        const paymentTypes = {
            pio: {
                purposeTemplate: 'Doprinos za PIO za {date}',
                account: '840000072131384311',
                recipient: 'Poreska uprava Republike Srbije',
                defaultAmount: '23947,02',
                defaultSF: '253'
            },
            zdro: {
                purposeTemplate: 'Doprinos za ZDRO za {date}',
                account: '840000072132584221',
                recipient: 'Poreska uprava Republike Srbije',
                defaultAmount: '10277,26',
                defaultSF: '253'
            },
            nez: {
                purposeTemplate: 'Doprinos za NZS za {date}',
                account: '840000072133184186',
                recipient: 'Poreska uprava Republike Srbije',
                defaultAmount: '748,34',
                defaultSF: '253'
            },
            paus: {
                purposeTemplate: 'Porez na pau≈°alni prihod za {date}',
                account: '840000071112284992',
                recipient: 'Poreska uprava Republike Srbije',
                defaultAmount: '9977,93',
                defaultSF: '253'
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∫–∏
        function updatePaymentFields() {
            const paymentType = document.getElementById('paymentType').value;
            const config = paymentTypes[paymentType];
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º
            const currentData = getCurrentFormData();
            const saved = localStorage.getItem('paymentFormData');
            let allSavedData = { currentType: paymentType, types: {} };
            if (saved) {
                try {
                    allSavedData = JSON.parse(saved);
                    if (!allSavedData.types) allSavedData.types = {};
                    if (!allSavedData.currentType) allSavedData.currentType = paymentType;
                } catch (e) {
                    allSavedData = { currentType: paymentType, types: {} };
                }
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ç–∏–ø–∞ (–µ—Å–ª–∏ –æ–Ω –±—ã–ª –∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ)
            const previousType = allSavedData.currentType;
            if (previousType && previousType !== paymentType && previousType in paymentTypes) {
                allSavedData.types[previousType] = currentData;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø
            allSavedData.currentType = paymentType;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ç–∏–ø–∞
            const savedTypeData = allSavedData.types && allSavedData.types[paymentType];
            
            if (config) {
                if (savedTypeData) {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
                    setFormDataForType(savedTypeData, true);
                } else {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
                    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Å –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –¥–∞—Ç—ã
                    const purposeField = document.getElementById('fieldS');
                    if (config.purposeTemplate) {
                        const date = getPreviousMonthYear();
                        purposeField.value = config.purposeTemplate.replace('{date}', date);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                    const recipientField = document.getElementById('fieldN');
                    if (config.recipient) {
                        recipientField.value = config.recipient;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                    const accountField = document.getElementById('fieldR');
                    accountField.value = config.account;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É - –í–°–ï–ì–î–ê —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å—É–º–º—É
                    const amountField = document.getElementById('fieldI');
                    if (config.defaultAmount) {
                        amountField.value = config.defaultAmount;
                    } else {
                        amountField.value = '0,00';
                    }
                }
                
                // –û—á–∏—â–∞–µ–º QR –∫–æ–¥ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∏–ø–∞
                const qrContainer = document.getElementById('qrcode');
                const existingImg = qrContainer.querySelector('img');
                if (existingImg) {
                    existingImg.remove();
                }
                const placeholder = qrContainer.querySelector('.qr-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
                const purposeField = document.getElementById('fieldS');
                const counter = document.getElementById('fieldSCounter');
                if (counter && purposeField) {
                    const length = purposeField.value.length;
                    const maxLength = 35;
                    const remaining = maxLength - length;
                    counter.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${remaining}`;
                    counter.className = 'char-counter';
                    if (remaining < 0) {
                        counter.className = 'char-counter error';
                    } else if (remaining < 5) {
                        counter.className = 'char-counter warning';
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞ –≤ localStorage (–ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π)
                allSavedData.currentType = paymentType;
                allSavedData.types[paymentType] = getCurrentFormData();
                localStorage.setItem('paymentFormData', JSON.stringify(allSavedData));
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –ø–ª–∞—Ç–µ–∂–∫—É
        function nextPayment() {
            const paymentTypeSelect = document.getElementById('paymentType');
            const types = ['pio', 'zdro', 'nez', 'paus'];
            const currentIndex = types.indexOf(paymentTypeSelect.value);
            const nextIndex = (currentIndex + 1) % types.length;
            
            paymentTypeSelect.value = types[nextIndex];
            updatePaymentFields();
        }

        // –°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –ø–æ–ª—è S
        document.addEventListener('DOMContentLoaded', function() {
            const fieldS = document.getElementById('fieldS');
            const counter = document.getElementById('fieldSCounter');
            
            function updateCounter() {
                if (!fieldS || !counter) return;
                const length = fieldS.value.length;
                const maxLength = 35;
                const remaining = maxLength - length;
                counter.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${remaining}`;
                counter.className = 'char-counter';
                if (remaining < 0) {
                    counter.className = 'char-counter error';
                } else if (remaining < 5) {
                    counter.className = 'char-counter warning';
                }
            }
            
            if (fieldS && counter) {
                fieldS.addEventListener('input', updateCounter);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∫–∏
            const paymentTypeSelect = document.getElementById('paymentType');
            if (paymentTypeSelect) {
                paymentTypeSelect.addEventListener('change', function() {
                    updatePaymentFields();
                    saveToLocalStorage();
                });
            }

            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
            const hasSavedData = loadFromLocalStorage();
            
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (!hasSavedData) {
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                document.getElementById('fieldP').value = 'IVAN IVANOV';
                document.getElementById('fieldSF').value = '253';
                document.getElementById('fieldRO').value = '976222390000007106318';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç–∏–ø –ø–ª–∞—Ç–µ–∂–∫–∏ (–ü–ò–û)
                paymentTypeSelect.value = 'pio';
                updatePaymentFields();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏—è
            updateCounter();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π
            const fieldsToSave = ['fieldP', 'fieldN', 'fieldR', 'fieldSF', 'fieldI', 'fieldRO', 'fieldS', 'fieldModel'];
            fieldsToSave.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', saveToLocalStorage);
                    field.addEventListener('change', saveToLocalStorage);
                }
            });
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–µ–±–∞–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        function updateDebugInfo(message, type = 'info', jsonData = null) {
            const debugInfo = document.getElementById('debugInfo');
            const debugJson = document.getElementById('debugJson');
            
            debugInfo.className = 'debug-info';
            if (type === 'error') {
                debugInfo.className = 'debug-error';
            } else if (type === 'success') {
                debugInfo.className = 'debug-success';
            }
            
            debugInfo.innerHTML = message;
            
            if (jsonData) {
                debugJson.textContent = JSON.stringify(jsonData, null, 2);
                debugJson.style.display = 'block';
            } else {
                debugJson.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–µ–±–∞–≥ —Å–µ–∫—Ü–∏–∏
        function toggleDebug() {
            const debugSection = document.querySelector('.debug-section');
            const debugBtn = document.getElementById('debugToggleBtn');
            
            if (debugSection.style.display === 'none' || !debugSection.style.display) {
                debugSection.style.display = 'block';
                debugBtn.textContent = '–°–∫—Ä—ã—Ç—å –æ—Ç–ª–∞–¥–∫—É';
            } else {
                debugSection.style.display = 'none';
                debugBtn.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–∫—É';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
        function getCurrentFormData() {
            return {
                fieldP: document.getElementById('fieldP').value,
                fieldN: document.getElementById('fieldN').value,
                fieldR: document.getElementById('fieldR').value,
                fieldSF: document.getElementById('fieldSF').value,
                fieldI: document.getElementById('fieldI').value,
                fieldRO: document.getElementById('fieldRO').value,
                fieldS: document.getElementById('fieldS').value,
                fieldModel: document.getElementById('fieldModel').value
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∫–∏
        function getDefaultDataForType(type) {
            const config = paymentTypes[type];
            if (!config) return null;
            
            const date = getPreviousMonthYear();
            const purpose = config.purposeTemplate.replace('{date}', date);
            
            return {
                fieldP: 'IVAN IVANOV',
                fieldN: config.recipient || '',
                fieldR: config.account || '',
                fieldSF: '253',
                fieldI: config.defaultAmount || '0,00',
                fieldRO: '976222390000007106318',
                fieldS: purpose,
                fieldModel: ''
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–ª–∞—Ç–µ–∂–µ–∫
        function getAllFormData() {
            const currentType = document.getElementById('paymentType').value;
            const allData = {
                currentType: currentType,
                types: {}
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
            allData.types[currentType] = getCurrentFormData();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∏–∑ localStorage
            const saved = localStorage.getItem('paymentFormData');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    if (savedData.types) {
                        // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤
                        Object.keys(savedData.types).forEach(type => {
                            if (type !== currentType) {
                                allData.types[type] = savedData.types[type];
                            }
                        });
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', e);
                }
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ —Ç–µ —Ç–∏–ø—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
            Object.keys(paymentTypes).forEach(type => {
                if (!allData.types[type]) {
                    allData.types[type] = getDefaultDataForType(type);
                }
            });
            
            return allData;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞
        function setFormDataForType(typeData, skipAutoGenerate = false) {
            if (typeData.fieldP !== undefined) document.getElementById('fieldP').value = typeData.fieldP || '';
            if (typeData.fieldN !== undefined) document.getElementById('fieldN').value = typeData.fieldN || '';
            if (typeData.fieldR !== undefined) document.getElementById('fieldR').value = typeData.fieldR || '';
            if (typeData.fieldSF !== undefined) document.getElementById('fieldSF').value = typeData.fieldSF || '';
            if (typeData.fieldI !== undefined) document.getElementById('fieldI').value = typeData.fieldI || '';
            if (typeData.fieldRO !== undefined) document.getElementById('fieldRO').value = typeData.fieldRO || '';
            if (typeData.fieldS !== undefined) document.getElementById('fieldS').value = typeData.fieldS || '';
            if (typeData.fieldModel !== undefined) document.getElementById('fieldModel').value = typeData.fieldModel || '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
            const purposeField = document.getElementById('fieldS');
            const counter = document.getElementById('fieldSCounter');
            if (counter && purposeField) {
                const length = purposeField.value.length;
                const maxLength = 35;
                const remaining = maxLength - length;
                counter.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${remaining}`;
                counter.className = 'char-counter';
                if (remaining < 0) {
                    counter.className = 'char-counter error';
                } else if (remaining < 5) {
                    counter.className = 'char-counter warning';
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
        function setAllFormData(data, skipAutoGenerate = false) {
            // –ï—Å–ª–∏ —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
            if (data.paymentType && !data.types) {
                if (data.paymentType) {
                    document.getElementById('paymentType').value = data.paymentType;
                }
                setFormDataForType(data, skipAutoGenerate);
                if (data.paymentType && !skipAutoGenerate) {
                    updatePaymentFields();
                }
                return;
            }
            
            // –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤
            if (data.currentType) {
                document.getElementById('paymentType').value = data.currentType;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –≤ localStorage
            if (data.types) {
                const currentType = data.currentType || document.getElementById('paymentType').value;
                const currentData = data.types[currentType];
                
                if (currentData) {
                    setFormDataForType(currentData, skipAutoGenerate);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Ç–∏–ø—ã –≤ localStorage
                localStorage.setItem('paymentFormData', JSON.stringify({
                    currentType: currentType,
                    types: data.types
                }));
            }
            
            if (!skipAutoGenerate && data.currentType) {
                updatePaymentFields();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage
        function saveToLocalStorage() {
            const currentType = document.getElementById('paymentType').value;
            const currentData = getCurrentFormData();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            const saved = localStorage.getItem('paymentFormData');
            let allData = { currentType: currentType, types: {} };
            if (saved) {
                try {
                    allData = JSON.parse(saved);
                    if (!allData.types) allData.types = {};
                } catch (e) {
                    allData = { currentType: currentType, types: {} };
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
            allData.currentType = currentType;
            allData.types[currentType] = currentData;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º
            localStorage.setItem('paymentFormData', JSON.stringify(allData));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('paymentFormData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    setAllFormData(data, true); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                    return true;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ localStorage:', e);
                    return false;
                }
            }
            return false;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª
        function saveToFile() {
            const data = getAllFormData();
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `payment-form-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            saveToLocalStorage();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Ñ–∞–π–ª–∞
        function loadFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    setAllFormData(data, true); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                    saveToLocalStorage();
                    
                    alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // –û—á–∏—â–∞–µ–º input —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª —Å–Ω–æ–≤–∞
            event.target.value = '';
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ QR –∫–æ–¥–∞
        window.generateQR = async function() {
            const qrContainer = document.getElementById('qrcode');
            const errorDiv = document.getElementById('error');
            const generateBtn = document.getElementById('generateBtn');

            // –û—á–∏—Å—Ç–∫–∞ –¥–µ–±–∞–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            updateDebugInfo('üîÑ –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞...', 'info');

            // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Å—Ç–∞–≤–ª—è—è placeholder
            const existingImg = qrContainer.querySelector('img');
            if (existingImg) {
                existingImg.remove();
            }
            const placeholder = qrContainer.querySelector('.qr-placeholder');
            if (placeholder) {
                placeholder.style.display = 'block';
            }
            errorDiv.textContent = '';
            errorDiv.className = 'error';
            generateBtn.disabled = true;
            generateBtn.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...';

            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
            const rawData = {
                K: hiddenFields.K,
                V: hiddenFields.V,
                C: hiddenFields.C,
                R: document.getElementById('fieldR').value,
                N: document.getElementById('fieldN').value,
                I: document.getElementById('fieldI').value,
                SF: document.getElementById('fieldSF').value,
                S: document.getElementById('fieldS').value,
                RO: document.getElementById('fieldRO').value,
                P: document.getElementById('fieldP').value
            };

            updateDebugInfo('üìã –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã:<br>' + 
                Object.entries(rawData).map(([k, v]) => `${k}: "${v}" (–¥–ª–∏–Ω–∞: ${v ? v.length : 0})`).join('<br>'), 
                'info', rawData);

            const jsonData = {
                "K": hiddenFields.K,
                "V": hiddenFields.V,
                "C": hiddenFields.C,
                "R": rawData.R.replace(/-/g, '').trim(),
                "N": processTextField(rawData.N),
                "I": "RSD" + rawData.I.trim(),
                "SF": rawData.SF.trim(),
                "S": processTextField(rawData.S),
                "RO": rawData.RO.trim()
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ P —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
            if (rawData.P && rawData.P.trim()) {
                jsonData["P"] = processTextField(rawData.P);
            }

            updateDebugInfo('‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'info', jsonData);

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            const requiredFields = ['K', 'V', 'C', 'R', 'N', 'I', 'SF', 'S', 'RO'];
            const missingFields = [];
            for (const field of requiredFields) {
                if (!jsonData[field]) {
                    missingFields.push(field);
                }
            }

            if (missingFields.length > 0) {
                const errorMsg = `‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: ${missingFields.join(', ')}<br>` +
                    `–î–µ—Ç–∞–ª–∏:<br>` +
                    missingFields.map(f => `- ${f}: "${jsonData[f]}" (–ø—É—Å—Ç–æ)`).join('<br>');
                updateDebugInfo(errorMsg, 'error', jsonData);
                errorDiv.textContent = `–ü–æ–ª—è ${missingFields.join(', ')} –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã`;
                errorDiv.className = 'error show';
                generateBtn.disabled = false;
                generateBtn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥';
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ —Å—É–º–º—ã
            const amountPattern = /^RSD\d+,\d{2}$/;
            if (!amountPattern.test(jsonData.I)) {
                const errorMsg = `‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã: "${jsonData.I}"<br>` +
                    `–û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: RSD{—á–∏—Å–ª–æ},{–¥–≤–µ —Ü–∏—Ñ—Ä—ã}<br>` +
                    `–ü—Ä–∏–º–µ—Ä: RSD1000,00`;
                updateDebugInfo(errorMsg, 'error', jsonData);
                errorDiv.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: —á–∏—Å–ª–æ,–¥–≤–µ —Ü–∏—Ñ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000,00)';
                errorDiv.className = 'error show';
                generateBtn.disabled = false;
                generateBtn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥';
                return;
            }

            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–ª–∏–Ω—ã –ø–æ–ª—è S
            if (jsonData.S.length > 35) {
                const errorMsg = `‚ùå –ü–æ–ª–µ S —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ: ${jsonData.S.length} —Å–∏–º–≤–æ–ª–æ–≤<br>` +
                    `–ú–∞–∫—Å–∏–º—É–º: 35 —Å–∏–º–≤–æ–ª–æ–≤<br>` +
                    `–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: "${jsonData.S}"`;
                updateDebugInfo(errorMsg, 'error', jsonData);
                errorDiv.textContent = `–ü–æ–ª–µ S —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º—É–º 35 —Å–∏–º–≤–æ–ª–æ–≤, —Å–µ–π—á–∞—Å: ${jsonData.S.length}`;
                errorDiv.className = 'error show';
                generateBtn.disabled = false;
                generateBtn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥';
                return;
            }

            updateDebugInfo('‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!<br>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ API...', 'success', jsonData);

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç
            const textData = jsonToTextFormat(jsonData);
            updateDebugInfo(`üìù –¢–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:<br><pre style="background:#fff;padding:5px;">${textData}</pre>`, 'info', jsonData);

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–∫—Å—Ç):', textData);
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (JSON):', JSON.stringify(jsonData, null, 2));

            // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL –¥–ª—è –º–µ—Ç–æ–¥–∞ generate
            const apiUrl = 'https://nbs.rs/QRcode/api/qr/v1/generate';
            const url = new URL(apiUrl);
            url.searchParams.append('lang', 'sr_RS');

            try {
                updateDebugInfo(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –Ω–∞: ${url.toString()}<br>Content-Type: text/plain`, 'info', jsonData);
                
                const response = await fetch(url.toString(), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: textData
                });

                generateBtn.disabled = false;
                generateBtn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥';

                // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
                let responseData;
                try {
                    const responseText = await response.text();
                    responseData = JSON.parse(responseText);
                } catch (parseError) {
                    updateDebugInfo(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –æ—Ç–≤–µ—Ç–∞:<br>` +
                        `–û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON<br>` +
                        `–û—à–∏–±–∫–∞: ${parseError.message}`, 'error', { text: textData });
                    errorDiv.textContent = '–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON';
                    errorDiv.className = 'error show';
                    return;
                }
                
                updateDebugInfo(`üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω: —Å—Ç–∞—Ç—É—Å ${response.status} ${response.statusText}<br>` +
                    `–ö–æ–¥: ${responseData.s?.code || 'N/A'}<br>` +
                    `–û–ø–∏—Å–∞–Ω–∏–µ: ${responseData.s?.desc || 'N/A'}`, 
                    responseData.s?.code === 0 ? 'success' : 'error', responseData);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
                if (responseData.s && responseData.s.code !== 0) {
                    const errorMsg = `‚ùå –û—à–∏–±–∫–∞ API (–∫–æ–¥ ${responseData.s.code}):<br>` +
                        `–û–ø–∏—Å–∞–Ω–∏–µ: ${responseData.s.desc || 'N/A'}<br>` +
                        (responseData.e ? `–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:<br><pre style="background:#fff;padding:5px;">${responseData.e.join('<br>')}</pre>` : '') +
                        `<br>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:<br><pre style="background:#fff;padding:5px;">${responseData.t || textData}</pre>`;
                    updateDebugInfo(errorMsg, 'error', responseData);
                    
                    errorDiv.textContent = `–û—à–∏–±–∫–∞ API (${responseData.s.code}): ${responseData.s.desc}`;
                    errorDiv.className = 'error show';
                    console.error('–û—à–∏–±–∫–∞ API:', responseData);
                    return;
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞
                if (!responseData.i) {
                    updateDebugInfo('‚ùå –û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR –∫–æ–¥–∞', 'error', responseData);
                    errorDiv.textContent = '–û—Ç–≤–µ—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ QR –∫–æ–¥–∞';
                    errorDiv.className = 'error show';
                    return;
                }

                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const imageUrl = 'data:image/png;base64,' + responseData.i;
                const imageSize = Math.round((responseData.i.length * 3) / 4 / 1024); // –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä

                updateDebugInfo(`‚úÖ QR –∫–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!<br>` +
                    `–†–∞–∑–º–µ—Ä: ~${imageSize} KB<br>` +
                    `–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç:<br><pre style="background:#fff;padding:5px;">${responseData.t || textData}</pre>`, 
                    'success', responseData);

                // –°–∫—Ä—ã–≤–∞–µ–º placeholder
                const placeholder = qrContainer.querySelector('.qr-placeholder');
                if (placeholder) {
                    placeholder.style.display = 'none';
                }

                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = 'NBS IPS QR Code';
                img.onerror = function() {
                    updateDebugInfo('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ QR –∫–æ–¥–∞ –∏–∑ base64', 'error', responseData);
                    errorDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ QR –∫–æ–¥–∞';
                    errorDiv.className = 'error show';
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder –æ–±—Ä–∞—Ç–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    if (placeholder) {
                        placeholder.style.display = 'block';
                    }
                };

                qrContainer.appendChild(img);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞
                saveToLocalStorage();

            } catch (error) {
                generateBtn.disabled = false;
                generateBtn.textContent = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥';
                
                const errorMsg = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:<br>` +
                    `–¢–∏–ø: ${error.name}<br>` +
                    `–°–æ–æ–±—â–µ–Ω–∏–µ: ${error.message}<br>` +
                    `–°—Ç–µ–∫: <pre style="background:#fff;padding:5px;">${error.stack || 'N/A'}</pre>`;
                updateDebugInfo(errorMsg, 'error', jsonData);
                
                errorDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message;
                errorDiv.className = 'error show';
            }
        };
    </script>
</body>
</html>
